const https = require('https')
const { Buffer } = require('node:buffer')

async function testMergeSort(len, min, max)  {
  const argsString = JSON.stringify(
    Array.from(arguments).slice(0, testMergeSort.length))

  const options = {
    hostname: process.env.AWS_GATEWAY_HOST,
    port: 443,
    path: "/testMergeSort",
    method: 'POST'
  };

  return request(options, argsString, 1)
}

async function getRandomIntArray(len, min, max)  {
  const argsString = JSON.stringify(
    Array.from(arguments).slice(0, getRandomIntArray.length))

  const options = {
    hostname: process.env.AWS_GATEWAY_HOST,
    port: 443,
    path: "/getRandomIntArray",
    method: 'POST'
  };

  return request(options, argsString, 1)
}

async function getRandomInt(min, max)  {
  const argsString = JSON.stringify(
    Array.from(arguments).slice(0, getRandomInt.length))

  const options = {
    hostname: process.env.AWS_GATEWAY_HOST,
    port: 443,
    path: "/getRandomInt",
    method: 'POST'
  };

  return request(options, argsString, 1)
}

async function mergeSort(arr)  {
  const argsString = JSON.stringify(
    Array.from(arguments).slice(0, mergeSort.length))

  const options = {
    hostname: process.env.AWS_GATEWAY_HOST,
    port: 443,
    path: "/mergeSort",
    method: 'POST'
  };

  return request(options, argsString, 1)
}

async function mergeSortPair(arr1, arr2)  {
  const argsString = JSON.stringify(
    Array.from(arguments).slice(0, mergeSortPair.length))

  const options = {
    hostname: process.env.AWS_GATEWAY_HOST,
    port: 443,
    path: "/mergeSortPair",
    method: 'POST'
  };

  return request(options, argsString, 1)
}

function request(options, argsString, curTryNum) {
  return new Promise((resolve, reject) => {
    const req = https.request(options, (res) => {
      let data = ''

      res.on('data', (chunk) => {
        data += chunk
      })

      res.on('end', () => {
        const result = JSON.parse(data)
        if (result.message === 'Service Unavailable') {
          console.error("Service is Unavailable, waiting 500 ms, currently try number: ", curTryNum)
          if (curTryNum > 10) {
            throw Error("Exhausted number of tries, failing")
          } else {
            setTimeout(() => {
              resolve(request(options, argsString, curTryNum + 1))
            }, 500)
          }
        } else {
          resolve(result)
        }
      })

      res.on('error', (e) => {
        console.error('Response Error: ', e)
        reject(e)
      })
    })

    req.setHeader('Content-Type', 'application/json')
    req.setHeader('Content-Length', Buffer.byteLength(argsString))

    req.on('error', (e) => {
      console.error('Request Error: ', e)
      reject(e)
    })

    req.end(argsString)
  })
}
module.exports = {
  testMergeSort,
  getRandomIntArray,
  getRandomInt,
  mergeSort,
  mergeSortPair
}
