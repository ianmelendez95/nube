{
    "Parameters": {
        "MergeSortBucket": {
            "Default": "mergesort-bucket",
            "Type": "String"
        }
    },
    "Resources": {
        "FrameTable": {
            "Properties": {
                "AttributeDefinitions": [
                    {
                        "AttributeName": "frameId",
                        "AttributeType": "S"
                    }
                ],
                "BillingMode": "PAY_PER_REQUEST",
                "KeySchema": [
                    {
                        "AttributeName": "frameId",
                        "KeyType": "HASH"
                    }
                ],
                "TableClass": "STANDARD",
                "TableName": "frame-table"
            },
            "Type": "AWS::DynamoDB::Table"
        },
        "MergeSortApi": {
            "Properties": {
                "Name": "mergeSort-api",
                "ProtocolType": "HTTP"
            },
            "Type": "AWS::ApiGatewayV2::Api"
        },
        "MergeSortApiStage": {
            "Properties": {
                "ApiId": {
                    "Ref": "MergeSortApi"
                },
                "AutoDeploy": true,
                "StageName": "$default"
            },
            "Type": "AWS::ApiGatewayV2::Stage"
        },
        "MergeSortLayer": {
            "Properties": {
                "CompatibleArchitectures": [
                    "x86_64"
                ],
                "CompatibleRuntimes": [
                    "nodejs22.x"
                ],
                "Content": {
                    "S3Bucket": {
                        "Ref": "MergeSortBucket"
                    },
                    "S3Key": "mergeSort-layer.zip"
                },
                "LayerName": "mergeSort-layer"
            },
            "Type": "AWS::Lambda::LayerVersion"
        },
        "MergeSortRole": {
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaSQSQueueExecutionRole"
                ],
                "MaxSessionDuration": 3600,
                "Path": "/service-role/",
                "Policies": [
                    {
                        "PolicyDocument": {
                            "Statement": [
                                {
                                    "Action": [
                                        "sqs:SendMessage"
                                    ],
                                    "Effect": "Allow",
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:*-queue"
                                    }
                                },
                                {
                                    "Action": [
                                        "dynamodb:PutItem",
                                        "dynamodb:GetItem",
                                        "dynamodb:UpdateItem",
                                        "dynamodb:DeleteItem",
                                        "dynamodb:Query"
                                    ],
                                    "Effect": "Allow",
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": "FrameTable.Arn"
                                        },
                                        {
                                            "Fn::GetAtt": "ResultTable.Arn"
                                        }
                                    ]
                                }
                            ],
                            "Version": "2012-10-17"
                        },
                        "PolicyName": "SQSAndDynamoPolicy"
                    }
                ],
                "RoleName": "mergeSort-role"
            },
            "Type": "AWS::IAM::Role"
        },
        "ResultTable": {
            "Properties": {
                "AttributeDefinitions": [
                    {
                        "AttributeName": "frameId",
                        "AttributeType": "S"
                    }
                ],
                "BillingMode": "PAY_PER_REQUEST",
                "KeySchema": [
                    {
                        "AttributeName": "frameId",
                        "KeyType": "HASH"
                    }
                ],
                "TableClass": "STANDARD",
                "TableName": "result-table"
            },
            "Type": "AWS::DynamoDB::Table"
        }
    }
}